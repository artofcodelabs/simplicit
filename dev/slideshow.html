<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Modest > Slideshow</title>
  </head>
  <body>
    <h1>Modest > Slideshow</h1>

    <h2>Slideshow</h2>
    <div data-component="slideshow">
      <button data-ref="previous"> â† </button>
      <button data-ref="next"> â†’ </button>

      <div data-component="slide"><span data-ref="caption">ğŸµ #1</span></div>
      <div data-component="slide"><span data-ref="caption">ğŸ™ˆ #2</span></div>
      <div data-component="slide"><span data-ref="caption">ğŸ™‰ #3</span></div>
      <div data-component="slide"><span data-ref="caption">ğŸ™Š #4</span></div>
    </div>

    <h2>Slideshow Manager</h2>
    <div data-component="slideshow-manager">
      <button data-ref="add-slide">Add slide</button>
      <button data-ref="show-slides">Show slides</button>
      <button data-ref="hide-slides">Hide slides</button>
      <button data-ref="manage-slides">Manage slides</button>
    </div>

    <script src="/loco-core.js"></script>
    <script>
      const { start, Component } = LocoCore;

      class Slide extends Component {
        static name = "slide";

        static template = ({ text, show, manage = false, current = false }) => {
          return `
          <div
            data-component="${Slide.name}"
            ${manage ? `data-mode="manage"` : ""}
            ${show ? "" : "hidden"}
          >
            ${current ? Slide.boldTextTemplate(text) : Slide.captionTemplate(text)}
          </div>
          `
        }

        static captionTemplate = (text) => {
          return `<span data-ref="caption">${text}</span>`;
        }

        static boldTextTemplate = (text) => {
          return `<b data-ref="bold-text">${text}</b>`;
        }

        static deleteButtonTemplate = () => {
          return `<a href="#" data-ref="delete" style="text-decoration: none;"> âŒ</a>`
        }

        constructor() {
          super();
          this.deleteButton = null;
        }

        isCurrent() {
          return this.ref("bold-text") !== null;
        }

        connect() {
          if (this.element.dataset.mode === "manage") {
            this.showDeleteButton();
          }
        }

        show() {
          this.element.hidden = false;
        }

        hide() {
          this.element.hidden = true;
        }

        setCurrent(isCurrent) {
          let bold = this.ref("bold-text");
          if (isCurrent) {
            if (bold) return;
            bold = this.constructor.boldTextTemplate(this.ref("caption").textContent);
            this.element.insertAdjacentHTML("afterbegin", bold);
            this.ref("caption").remove();
          } else {
            if (!bold) return;
            const caption = this.constructor.captionTemplate(bold.textContent);
            this.element.insertAdjacentHTML("afterbegin", caption);
            bold.remove();
          }
        }

        showDeleteButton() {
          if (this.isCurrent()) return;
          // TODO: don't add but hide for simplicity
          if (this.deleteButton) {
            this.deleteButton.hidden = false;
            return;
          }
          this.element.insertAdjacentHTML(
            "beforeend",
            this.constructor.deleteButtonTemplate(),
          );
          this.deleteButton = this.ref("delete");
          this.on(this.deleteButton, "click", (e) => {
            e.preventDefault();
            this.element.remove();
          });
        }

        hideDeleteButton() {
          this.deleteButton.hidden = true;
        }
      }

      class Slideshow extends Component {
        static name = "slideshow";

        constructor() {
          super();
          this.index = 0;
          this.manageSlides = false;
        }

        get slidesNumber() {
          return this.children("slide").length;
        }

        connect() {
          this.on(this.ref("previous"), "click", () => this.#changeIndex(-1));
          this.on(this.ref("next"), "click", () => this.#changeIndex(1));
          this.#setCurrentSlide();
          this.hideSlides();
        }

        addSlide({ text, show }) {
          const isFirstSlide = this.slidesNumber === 0;
          const slideHtml = Slide.template({
            text,
            show,
            manage: this.manageSlides,
            current: isFirstSlide,
          });
          this.element.insertAdjacentHTML("beforeend", slideHtml);
          if (isFirstSlide) {
            this.index = 0; // TODO: isn't index already 0?
          }
        }

        showSlides() {
          this.children().forEach((slide) => slide.show());
        }

        hideSlides() {
          this.children().forEach((slide, index) => {
            if (index !== this.index) slide.hide();
          });
        }

        toggleDeleteButtons() {
          this.manageSlides = !this.manageSlides;
          this.children().forEach((slide) => this.manageSlides ? slide.showDeleteButton() : slide.hideDeleteButton());
        }

        #changeIndex(diff = 0) {
          this.index += diff;
          if (this.index >= this.slidesNumber) {
            this.index = 0;
          }
          if (this.index < 0) {
            this.index = this.slidesNumber - 1;
          }
          this.#setCurrentSlide();
        }

        #setCurrentSlide() {
          this.children().forEach((slide, index) => {
            slide.setCurrent(index === this.index);
          });
        }
      }

      class SlideshowManager extends Component {
        static name = "slideshow-manager";

        constructor() {
          super();
          this.showAll = false;
        }

        get slideshow() {
          return this.siblings("slideshow")[0];
        }

        connect() {
          this.on(this.ref("add-slide"), "click", () => this.#addSlide());
          this.on(this.ref("show-slides"), "click", () => this.#showSlides());
          this.on(this.ref("hide-slides"), "click", () => this.#hideSlides());
          this.on(this.ref("manage-slides"), "click", () => this.#manageSlides());
        }

        #addSlide() {
          const slidesNumber = this.slideshow.slidesNumber;
          this.slideshow.addSlide({ text: `ğŸ’ #${slidesNumber + 1}`, show: this.showAll });
        }

        #showSlides() {
          this.showAll = true;
          this.slideshow.showSlides();
        }

        #hideSlides() {
          this.showAll = false;
          this.slideshow.hideSlides();
        }

        #manageSlides() {
          this.slideshow.toggleDeleteButtons();
        }
      }

      const app = start({ components: [Slide, Slideshow, SlideshowManager] });
    </script>

    <p>
      <a href="/">Modest</a>
    </p>
  </body>
</html>
