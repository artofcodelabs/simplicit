<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Modest > Slideshow</title>
  </head>
  <body>
    <h1>Modest > Slideshow</h1>

    <h2>Slideshow</h2>
    <div data-component="slideshow" id="slideshow">
      <button data-ref="previous"> â† </button>
      <button data-ref="next"> â†’ </button>

      <script type="application/json" data-component="slide" data-target="slideshow" data-position="beforeend">
        [
          { "text": "ğŸµ #A" },
          { "text": "ğŸ™ˆ #B" },
          { "text": "ğŸ™‰ #C" },
          { "text": "ğŸ™Š #D" }
        ]
      </script>
    </div>

    <h2>Slideshow Manager</h2>
    <div data-component="slideshow-manager">
      <button data-ref="add-slide">Add slide</button>
      <button data-ref="show-slides">Show slides</button>
      <button data-ref="hide-slides">Hide slides</button>
      <button data-ref="manage-slides" disabled>Manage slides</button>
    </div>

    <script src="/loco-core.js"></script>
    <script>
      const { start, Component } = LocoCore;

      class Slide extends Component {
        static name = "slide";

        // render
        static template = ({ text, show = false, manage = false }) => {
          return `
          <div
            data-component="${Slide.name}"
            ${show ? "" : "hidden"}
          >
            ${Slide.captionTemplate(text, manage)}
            <a href="#" data-ref="delete" style="text-decoration: none;" ${manage ? "" : "hidden"}> âŒ</a>
          </div>
          `;
        }

        static captionTemplate = (text, manage) => {
          return `
          <span data-ref="caption" style="cursor: ${manage ? "pointer" : "default"};">
            ${text}
          </span>
          `;
        }

        static boldTextTemplate = (text) => {
          return `<b data-ref="bold-text">${text}</b>`;
        }

        static editTemplate = (text) => {
          return `<input type="text" data-ref="edit" value="${text}" />`;
        }

        constructor() {
          super();
          this.current = false;
          this.disableCaptionClick = null;
        }

        // rendered
        connect() {
          this.on(this.ref("delete"), "click", (e) => {
            e.preventDefault();
            this.element.remove();
          });
          this.#addCaptionClick();
          this.parent.checkIn(this);
        }

        show() {
          this.element.hidden = false;
        }

        hide() {
          if (this.current) return;
          this.element.hidden = true;
        }

        changeCurrent({ current, show, manage }) {
          if (current && !this.current) {
            this.#disableManagement();
            this.#captionToBold();
            this.current = true;
            this.show();
          } else if (!current && this.current) {
            this.#boldToCaption();
            this.current = false;
            this.changeMode(manage);
            show ? this.show() : this.hide();
          }
        }

        changeMode(manage) {
          if (this.current) return;

          if ( manage && !this.#isInManagement() ) {
            this.#enableManagement();
          } else if ( !manage && this.#isInManagement() ) {
            this.#disableManagement();
          }
        }

        #isInManagement() {
          return this.ref("delete").hidden === false;
        }

        #addCaptionClick() {
          this.disableCaptionClick = this.on(this.ref('caption'), 'click', () => {
            if (!this.#isInManagement()) return;

            this.#captionToEdit();
          });
        }

        #captionToBold() {
          const bold = this.constructor.boldTextTemplate(this.ref("caption").textContent);
          this.element.insertAdjacentHTML("afterbegin", bold);
          this.#removeCaption();
        }

        #boldToCaption() {
          const caption = this.constructor.captionTemplate(this.ref("bold-text").textContent);
          this.element.insertAdjacentHTML("afterbegin", caption);
          this.#addCaptionClick();
          this.ref("bold-text").remove();
        }

        #removeCaption() {
          this.disableCaptionClick();
          this.ref("caption").remove();
        }

        #captionToEdit() {
          const edit = this.constructor.editTemplate(this.ref("caption").textContent);
          this.element.insertAdjacentHTML("afterbegin", edit);
          this.#removeCaption();
        }

        #enableManagement() {
          this.ref("delete").hidden = false;
          this.ref("caption").style.cursor = "pointer";
          this.#addCaptionClick();
        }

        #disableManagement() {
          this.disableCaptionClick();
          this.ref("caption").style.cursor = "default";
          this.ref("delete").hidden = true;
        }
      }

      class Slideshow extends Component {
        static name = "slideshow";

        constructor() {
          super();
          this.showAll = false;
          this.manageSlides = false;
        }

        get slidesNumber() {
          return this.children("slide").length;
        }

        get currentSlideIndex() {
          return this.children("slide").findIndex((slide) => slide.current);
        }

        connect() {
          this.on(this.ref("previous"), "click", () => this.#changeCurrentSlideIndex(-1));
          this.on(this.ref("next"), "click", () => this.#changeCurrentSlideIndex(1));
        }

        checkIn(slide) {
          if (this.currentSlideIndex !== -1) return;
          const initCurrentSlideIndex = 1;
          if (this.children("slide").findIndex((s) => s === slide) === initCurrentSlideIndex) {
            this.#changeCurrentSlide(initCurrentSlideIndex);
          }
        }

        addSlide(text) {
          const slideHtml = Slide.template({
            text,
            show: this.showAll,
            manage: this.manageSlides,
          });
          this.element.insertAdjacentHTML("beforeend", slideHtml);
        }

        showSlides() {
          this.showAll = true;
          this.children().forEach((slide) => slide.show());
        }

        hideSlides() {
          this.showAll = false;
          this.children().forEach((slide) => slide.hide());
        }

        showDeleteButtons() {
          this.manageSlides = true;
          this.children().forEach((slide) => slide.changeMode(true));
        }

        hideDeleteButtons() {
          this.manageSlides = false;
          this.children().forEach((slide) => slide.changeMode(false));
        }

        #changeCurrentSlideIndex(diff = 0) {
          let newIndex = this.currentSlideIndex + diff;
          if (newIndex >= this.slidesNumber) {
            newIndex = 0;
          }
          if (newIndex < 0) {
            newIndex = this.slidesNumber - 1;
          }
          this.#changeCurrentSlide(newIndex);
        }

        #changeCurrentSlide(newIndex) {
          this.children().forEach((slide, index) => {
            slide.changeCurrent({ current: index === newIndex, show: this.showAll, manage: this.manageSlides });
          });
        }
      }

      class SlideshowManager extends Component {
        static name = "slideshow-manager";

        constructor() {
          super();
          this.manageSlides = false;
        }

        get slideshow() {
          return this.siblings("slideshow")[0];
        }

        connect() {
          this.on(this.ref("add-slide"), "click", () => this.#addSlide());
          this.on(this.ref("show-slides"), "click", () => this.#showSlides());
          this.on(this.ref("hide-slides"), "click", () => this.#hideSlides());
          this.on(this.ref("manage-slides"), "click", () => this.#manageSlides());
        }

        #addSlide() {
          const slidesNumber = this.slideshow.slidesNumber;
          this.slideshow.addSlide(`ğŸ’ #${slidesNumber + 1}`);
        }

        #showSlides() {
          this.slideshow.showSlides();
          this.ref("manage-slides").disabled = false;
        }

        #hideSlides() {
          this.slideshow.hideSlides();
          this.ref("manage-slides").disabled = true;
          this.manageSlides = false;
          this.slideshow.hideDeleteButtons();
        }

        #manageSlides() {
          this.manageSlides = !this.manageSlides;
          if (this.manageSlides) {
            this.slideshow.showDeleteButtons();
          } else {
            this.slideshow.hideDeleteButtons();
          }
        }
      }

      const app = start({ components: [Slide, Slideshow, SlideshowManager] });
      console.log(app.components);
    </script>

    <p>
      <a href="/">Modest</a>
    </p>
  </body>
</html>
